<!DOCTYPE HTML>
<html lang="en-US">
    <head prefix="og: http://ogp.me/ns# book: http://ogp.me/ns/book#">
        
        <meta charset="UTF-8">
        <title>Backbone of the OS and C++ runtime | How to Make a Computer Operating System in C++</title>

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="robots" content="index, follow">
        <meta name="author" content="SamyPesse">
        <meta name="description" content="Online book about how to write a computer operating system in C/C++ from scratch">
        <meta name="keywords" content="gitbook,github" >
        <meta name="generator" content="www.gitbook.io">

        
        <link rel="next" href="../Chapter-5/README.html" />
        
        
        <link rel="prev" href="../Chapter-3/README.html" />
        

        <meta property="og:title" content="Backbone of the OS and C++ runtime | How to Make a Computer Operating System in C++">
        <meta property="og:site_name" content="How to Make a Computer Operating System in C++">
        <meta property="og:type" content="book">
        <meta property="og:locale" content="en_US">

        <meta property="book:author" content="https://github.com/SamyPesse">
        <meta property="book:tag" content="GitBook">
        
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">

        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        <link rel="stylesheet" href="../gitbook/style.css">

        <script type="text/javascript">
        (function(e,b){if(!b.__SV){var a,f,i,g;window.mixpanel=b;b._i=[];b.init=function(a,e,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}}var c=b;"undefined"!==typeof d?c=b[d]=[]:d="mixpanel";c.people=c.people||[];c.toString=function(b){var a="mixpanel";"mixpanel"!==d&&(a+="."+d);b||(a+=" (stub)");return a};c.people.toString=function(){return c.toString(1)+".people (stub)"};i="disable track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config people.set people.set_once people.increment people.append people.track_charge people.clear_charges people.delete_user".split(" ");
        for(g=0;g<i.length;g++)f(c,i[g]);b._i.push([a,e,d])};b.__SV=1.2;a=e.createElement("script");a.type="text/javascript";a.src=("https:"===e.location.protocol?"https:":"http:")+'//cdn.mxpnl.com/libs/mixpanel-2.2.min.js';f=e.getElementsByTagName("script")[0];f.parentNode.insertBefore(a,f)}})(document,window.mixpanel||[]);
        mixpanel.init("01eb2b950ae09a5fdb15a98dcc5ff20e");
        </script>
        
    </head>
    <body>
        
<div class="book with-summary" data-github="SamyPesse/How-to-Make-a-Computer-Operating-System" data-level="4">
    <div class="book-header">
    <!-- Actions Left -->
    <a href="https://github.com/SamyPesse/How-to-Make-a-Computer-Operating-System" target="_blank" class="btn pull-left"><i class="fa fa-github-alt"></i></a>
    <a href="#" class="btn pull-left toggle-summary"><i class="fa fa-align-justify"></i></a>

    <!-- Actions Right -->
    <a href="#" target="_blank" class="btn pull-right" data-sharing="google-plus"><i class="fa fa-google-plus"></i></a>
    <a href="#" target="_blank" class="btn pull-right" data-sharing="facebook"><i class="fa fa-facebook"></i></a>
    <a href="#" target="_blank" class="btn pull-right" data-sharing="twitter"><i class="fa fa-twitter"></i></a>

    <a href="https://github.com/SamyPesse/How-to-Make-a-Computer-Operating-System/stargazers" target="_blank" class="btn pull-right count-star"><i class="fa fa-star-o"></i> Star (<span>-</span>)</a>
    <a href="https://github.com/SamyPesse/How-to-Make-a-Computer-Operating-System/watchers" target="_blank" class="btn pull-right count-watch"><i class="fa fa-eye"></i> Watch (<span>-</span>)</a>


    <!-- Title -->
    <h1><a href="../README.html" >How to Make a Computer Operating System in C++</a></h1>
</div>
    <div class="book-summary">
    <ul class="summary">
        <li>
            <a href="https://github.com/SamyPesse" target="blank">About the author</a>
        </li>
        <li>
            <a href="https://github.com/SamyPesse/How-to-Make-a-Computer-Operating-System/issues" target="blank">Questions and Issues</a>
        </li>
        <li>
            <a href="https://github.com/SamyPesse/How-to-Make-a-Computer-Operating-System/edit/master/Chapter-4/README.md" target="blank">Edit and Contribute</a>
        </li>
        <li class="divider"></li>
        <li data-level="0">
            <a href="../README.html"><i class="fa fa-check"></i> Introduction</a>
        </li>
        
            <li  data-level="1">
                
                <a href="../Chapter-1/README.html">
                    <i class="fa fa-check"></i> <b>1)</b> Introduction about the x86 architecture and about our OS
                </a>
                
                
            </li>
        
            <li  data-level="2">
                
                <a href="../Chapter-2/README.html">
                    <i class="fa fa-check"></i> <b>2)</b> Setup the development environment
                </a>
                
                
            </li>
        
            <li  data-level="3">
                
                <a href="../Chapter-3/README.html">
                    <i class="fa fa-check"></i> <b>3)</b> First boot with GRUB
                </a>
                
                
            </li>
        
            <li class="active" data-level="4">
                
                <a href="../Chapter-4/README.html">
                    <i class="fa fa-check"></i> <b>4)</b> Backbone of the OS and C++ runtime
                </a>
                
                
            </li>
        
            <li  data-level="5">
                
                <a href="../Chapter-5/README.html">
                    <i class="fa fa-check"></i> <b>5)</b> Base classes for managing x86 architecture
                </a>
                
                
            </li>
        
            <li  data-level="6">
                
                <a href="../Chapter-6/README.html">
                    <i class="fa fa-check"></i> <b>6)</b> GDT
                </a>
                
                
            </li>
        
            <li  data-level="7">
                
                <a href="../Chapter-7/README.html">
                    <i class="fa fa-check"></i> <b>7)</b> IDT and interrupts
                </a>
                
                
            </li>
        
            <li  data-level="8">
                
                <a href="../Chapter-8/README.html">
                    <i class="fa fa-check"></i> <b>8)</b> Memory management: physical and virtual
                </a>
                
                
            </li>
        
            <li  data-level="9">
                
                <span><b>9)</b> Process management and multitasking</span>
                
                
            </li>
        
            <li  data-level="10">
                
                <span><b>10)</b> External program execution: ELF files</span>
                
                
            </li>
        
            <li  data-level="11">
                
                <span><b>11)</b> Userland and syscalls</span>
                
                
            </li>
        
            <li  data-level="12">
                
                <span><b>12)</b> Modular drivers</span>
                
                
            </li>
        
            <li  data-level="13">
                
                <span><b>13)</b> Some basics modules: console, keyboard</span>
                
                
            </li>
        
            <li  data-level="14">
                
                <span><b>14)</b> IDE Hard disks</span>
                
                
            </li>
        
            <li  data-level="15">
                
                <span><b>15)</b> DOS Partitions</span>
                
                
            </li>
        
            <li  data-level="16">
                
                <span><b>16)</b> EXT2 read-only filesystems</span>
                
                
            </li>
        
            <li  data-level="17">
                
                <span><b>17)</b> Standard C library (libC)</span>
                
                
            </li>
        
            <li  data-level="18">
                
                <span><b>18)</b> UNIX basic tools: sh, cat</span>
                
                
            </li>
        
            <li  data-level="19">
                
                <span><b>19)</b> Lua interpreter</span>
                
                
            </li>
        
    </ul>
</div>
    <div class="book-body" tabindex="-1">
        <div class="page-wrapper">
            <div class="book-progress">
                <div class="bar">
                    <div class="inner" style="width: 50%;min-width: 37.5%;"></div>
                </div>
                <div class="chapters">
                
                    <a href="../README.html" title="Introduction" class="chapter done new-chapter" data-progress="0" style="left: 0%;"></a>
                
                    <a href="../Chapter-1/README.html" title="Introduction about the x86 architecture and about our OS" class="chapter done new-chapter" data-progress="1" style="left: 12.5%;"></a>
                
                    <a href="../Chapter-2/README.html" title="Setup the development environment" class="chapter done new-chapter" data-progress="2" style="left: 25%;"></a>
                
                    <a href="../Chapter-3/README.html" title="First boot with GRUB" class="chapter done new-chapter" data-progress="3" style="left: 37.5%;"></a>
                
                    <a href="../Chapter-4/README.html" title="Backbone of the OS and C++ runtime" class="chapter done new-chapter" data-progress="4" style="left: 50%;"></a>
                
                    <a href="../Chapter-5/README.html" title="Base classes for managing x86 architecture" class="chapter  new-chapter" data-progress="5" style="left: 62.5%;"></a>
                
                    <a href="../Chapter-6/README.html" title="GDT" class="chapter  new-chapter" data-progress="6" style="left: 75%;"></a>
                
                    <a href="../Chapter-7/README.html" title="IDT and interrupts" class="chapter  new-chapter" data-progress="7" style="left: 87.5%;"></a>
                
                    <a href="../Chapter-8/README.html" title="Memory management: physical and virtual" class="chapter  new-chapter" data-progress="8" style="left: 100%;"></a>
                
                </div>
            </div>

            <div class="page-inner">
            
                <section class="normal" id="section-gitbook_5">
                
                    <h2 id="chapter-4-backbone-of-the-os-and-c-runtime">Chapter 4: Backbone of the OS and C++ runtime</h2>
<h4 id="c-kernel-run-time">C++ kernel run-time</h4>
<p>A kernel can be programmed in C++, it is very similar to making a kernel in C, except that there are a few pitfalls you must take into account (runtime support, constructors, ...)</p>
<p>The compiler will assume that all the necessary C++ runtime support is available by default, but as we are not linking in libsupc++ into your C++ kernel, we need to add some basic functions that can be found in the <a href="https://github.com/SamyPesse/How-to-Make-a-Computer-Operating-System/blob/master/src/kernel/runtime/cxx.cc" target="_blank">cxx.cc</a> file.</p>
<p><strong>Caution:</strong> The operators <code>new</code> and <code>delete</code> cannot be used before virtual memory and pagination have been initialized.</p>
<h4 id="basic-c-c-functions">Basic C/C++ functions</h4>
<p>The kernel code can&#39;t use functions from the standard libraries so we need to add some basic functions for managing memory and strings:</p>
<pre><code class="lang-cpp"><span class="hljs-keyword">void</span>     itoa(<span class="hljs-keyword">char</span> *buf, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">int</span> n, <span class="hljs-keyword">int</span> base);

<span class="hljs-keyword">void</span> *    <span class="hljs-built_in">memset</span>(<span class="hljs-keyword">char</span> *dst,<span class="hljs-keyword">char</span> src, <span class="hljs-keyword">int</span> n);
<span class="hljs-keyword">void</span> *    <span class="hljs-built_in">memcpy</span>(<span class="hljs-keyword">char</span> *dst, <span class="hljs-keyword">char</span> *src, <span class="hljs-keyword">int</span> n);

<span class="hljs-keyword">int</span>     <span class="hljs-built_in">strlen</span>(<span class="hljs-keyword">char</span> *s);
<span class="hljs-keyword">int</span>     <span class="hljs-built_in">strcmp</span>(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *dst, <span class="hljs-keyword">char</span> *src);
<span class="hljs-keyword">int</span>     <span class="hljs-built_in">strcpy</span>(<span class="hljs-keyword">char</span> *dst,<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *src);
<span class="hljs-keyword">void</span>     <span class="hljs-built_in">strcat</span>(<span class="hljs-keyword">void</span> *dest,<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *src);
<span class="hljs-keyword">char</span> *    <span class="hljs-built_in">strncpy</span>(<span class="hljs-keyword">char</span> *destString, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *sourceString,<span class="hljs-keyword">int</span> maxLength);
<span class="hljs-keyword">int</span>     <span class="hljs-built_in">strncmp</span>( <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* s1, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* s2, <span class="hljs-keyword">int</span> c );
</code></pre>
<p>These functions are defined in <a href="https://github.com/SamyPesse/How-to-Make-a-Computer-Operating-System/blob/master/src/kernel/runtime/string.cc" target="_blank">string.cc</a>, <a href="https://github.com/SamyPesse/How-to-Make-a-Computer-Operating-System/blob/master/src/kernel/runtime/memory.cc" target="_blank">memory.cc</a>, <a href="https://github.com/SamyPesse/How-to-Make-a-Computer-Operating-System/blob/master/src/kernel/runtime/itoa.cc" target="_blank">itoa.cc</a></p>
<h4 id="c-types">C types</h4>
<p>During the next step, we are going to use different types in our code, most of the types we are going to use unsigned types (all the bits are used to stored the integer, in signed types one bit is used to signal the sign):</p>
<pre><code class="lang-cpp"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>     u8;
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">short</span>     u16;
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>     u32;
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span>     u64;

<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">signed</span> <span class="hljs-keyword">char</span>     s8;
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">signed</span> <span class="hljs-keyword">short</span>     s16;
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">signed</span> <span class="hljs-keyword">int</span>         s32;
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">signed</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span>    s64;
</code></pre>
<h4 id="compile-our-kernel">Compile our kernel</h4>
<p>Compiling a kernel is not the same thing as compiling a linux executable, we can&#39;t use a standard library and should have no dependencies to the system.</p>
<p>Our <a href="https://github.com/SamyPesse/How-to-Make-a-Computer-Operating-System/blob/master/src/kernel/Makefile" target="_blank">Makefile</a> will define the process to compile and link our kernel.</p>
<p>For x86 architecture, the followings arguments will be used for gcc/g++/ld:</p>
<pre><code><span class="hljs-comment"># Linker</span>
<span class="hljs-constant">LD</span>=ld
<span class="hljs-constant">LDFLAG</span>= -melf_i386 -static  -L ./  -T ./arch/<span class="hljs-variable">$(ARCH)</span>/linker.ld

<span class="hljs-comment"># C++ compiler</span>
<span class="hljs-constant">SC</span>=g++
<span class="hljs-constant">FLAG</span>= <span class="hljs-variable">$(INCDIR)</span> -g -O2 -w -trigraphs -fno-builtin  -fno-exceptions -fno-stack-protector -O0 -m32  -fno-rtti -nostdlib -nodefaultlibs 

<span class="hljs-comment"># Assembly compiler</span>
<span class="hljs-constant">ASM</span>=nasm
<span class="hljs-constant">ASMFLAG</span>=-f elf -o
</code></pre>
                
                </section>
            
            </div>

            <div class="page-footer">
                
                    
                        
                        <a href="../Chapter-5/README.html" class="navigation-link next">Next</a>
                        
                    
                
            </div>
        </div>
    </div>
</div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/ace.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/mode-javascript.js"></script>
        <script src="../gitbook/jsrepl/jsrepl.js" id="jsrepl-script"></script>
        <script src="../gitbook/app.js"></script>
    </body>
</html>